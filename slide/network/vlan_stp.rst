========================================
L2ネットワークについて(VLANとかSTPとか)
========================================

:Version:
    1.0 of 2011/03/03

:Author:
    SUZUKI Masashi

:Mail:
    m15.suzuki.masashi@gmail.com

L2ネットワーク
==============

  * Layer2

    * データリンク層 (OSI / TCP/IP)

  * MACアドレスを元にルーティング(スイッチング)を行う
  * ブロードキャストフレームが届く範囲

    * ブロードキャストドメイン
    * 直接通信できる範囲
    * いわゆるLAN

L2ネットワーク Cont..
======================

::

   +-----+   +-----+   +-----+
   | PC1 |---| SW  |---| PC2 |
   +-----+   +-----+   +-----+
                |
             +-----+
             | RT  |
             +-----+
                |
   +-----+   +-----+   +-----+
   | PC3 |-- | SW  |-- | PC4 |
   +-----+   +-----+   +-----+


スイッチング
============

PC1からPC3にフレームを送信する場合を考える。

  1. PC1はSWに(ユニキャスト)フレームを転送する。
  2. SWは送信元PC1のMACアドレスを学習する。
  3. SWは受信したポート以外のポートへフレームを転送する(フラッディング)
  4. PC3がフレームを受信する。

  * SWはPC1のMACアドレスを学習したのでこれ以降、PC1宛のフレームをフラッディングしない。


::

   +-----+   +-----+   +-----+
   | PC1 |---| SW  |---| PC2 |
   +-----+   +-----+   +-----+
            /   |   \
   +-----+ / +-----+ \ +-----+
   | PC3 |/  | PC4 |  \| PC5 |
   +-----+   +-----+   +-----+

ブロードキャスト
=================

  * MACアドレス FF-FF-FF-FF-FF-FF に送信する。
  * L2ネットワーク内のすべてのノードにフレームを送信する。
  * 結構頻繁に発生する。

    * ARPリクエスト
    * DHCP

  * ネットワーク設計上、ブロードキャストドメインはなるべく小さい方が良い。

    * ブロードキャストドメインを小さくするための対策としてのVLAN

VLAN
=====

  * 物理的には1台のスイッチ内に仮想のスイッチが複数台存在するイメージ。
  * 物理ポートに縛られず、柔軟にL2ネットワークを構築できる。
  * VLAN間で通信するにはL3(VLAN間)ルーティングが必要。

::

                  +----------+
                  |    RT    |
                  +----------+
                       |
   +----------+   +----------+   +----------+
   | PC1(VL1) |---|   L2SW   |---| PC2(VL2) |
   +----------+   +----------+   +----------+
                 /     |      \
   +----------+ / +----------+ \ +----------+
   | PC3(VL1) |/  | PC4(VL1) |  \| PC5(VL2) |
   +----------+   +----------+   +----------+

VLAN(用語)
==========

  * スイッチポート

    * アクセスポート

      * 1つのVLANのみ所属できるポート
      * いわゆる普通のスイッチポート

    * トランクポート

      * 複数のVLANに所属できるポート

    * ルーテッドポート

      * IPアドレス割り振られているポート
      * ルーターのインターフェースのイメージ

    * SVI

      * L3スイッチの内部インターフェース

  * VLANの形式

    * スタティックVLAN
    * ダイナミックVLAN

VLAN間ルーティング
===================

ルータがトランクポートに非対応の場合、ルータのポートを2つ使う。

::

                  +----------+
                  |    RT    |
                  +----------+
             VL1 →  |    | ← VL2
   +----------+   +----------+   +----------+
   | PC1(VL1) |---|   L2SW   |---| PC2(VL2) |
   +----------+   +----------+   +----------+
                 /     |      \
   +----------+ / +----------+ \ +----------+
   | PC3(VL1) |/  | PC4(VL1) |  \| PC5(VL2) |
   +----------+   +----------+   +----------+

VLAN間ルーティング cont...
===========================

ルータがトランクポートに対応の場合、ルータのポートを1つにサブインターフェースを割り当てる。

::

                  +----------+
                  |    RT    |
                  +----------+
     トランクポート →  |
   +----------+   +----------+   +----------+
   | PC1(VL1) |---|   L2SW   |---| PC2(VL2) |
   +----------+   +----------+   +----------+
                 /     |      \
   +----------+ / +----------+ \ +----------+
   | PC3(VL1) |/  | PC4(VL1) |  \| PC5(VL2) |
   +----------+   +----------+   +----------+

VLAN間ルーティング cont....
============================

L3スイッチを使う場合、L3スイッチ内でルーティングをすることができる。

::

   +----------+   +----------+   +----------+
   | PC1(VL1) |---|   L3SW   |---| PC2(VL2) |
   +----------+   +----------+   +----------+
                 /     |      \
   +----------+ / +----------+ \ +----------+
   | PC3(VL1) |/  | PC4(VL1) |  \| PC5(VL2) |
   +----------+   +----------+   +----------+

ブロードキャストストーム
========================

PC1からにブロードキャストフレームを送信する場合を考える。

  1. PC1からSW1に送信される。
  2. SW1からSW2とSW3にフラッディングされる。
  3. SW2からSW4とPC2にフラッディングされる。
  4. SW4からSW3とPC4にフラッディングされる。
  5. SW3からSW1とPC3にフラッディングされる。
  6. ...以下繰り返し。

::

   +-----+   +-----+   +-----+   +-----+
   | PC1 |---| SW1 |---| SW2 |---| PC2 |
   +-----+   +-----+   +-----+   +-----+
                |         |
   +-----+   +-----+   +-----+   +-----+
   | PC3 |---| SW3 |---| SW4 |---| PC4 |
   +-----+   +-----+   +-----+   +-----+

STP
====

  * ブロードキャストストームを防ぐための技術

