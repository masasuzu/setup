========================================
L2ネットワークについて(VLANとかSTPとか)
========================================

:Version:
    1.0 of 2011/03/03

:Author:
    SUZUKI Masashi

:Mail:
    m15.suzuki.masashi@gmail.com

Agenda
=======

1. L2ネットワークについての軽い説明
2. VLAN
3. STP

L2ネットワーク
==============

* Layer2

  * データリンク層 (OSI / TCP/IP)

* MACアドレスを元にルーティング(スイッチング)を行う
* ブロードキャストフレームが届く範囲

  * ブロードキャストドメイン
  * 直接通信できる範囲
  * いわゆるLAN

L2ネットワーク Cont..
======================

::

   +-----+   +-----+   +-----+
   | PC1 |---| SW  |---| PC2 |
   +-----+   +-----+   +-----+
                |
             +-----+
             | RT  |
             +-----+
                |
   +-----+   +-----+   +-----+
   | PC3 |-- | SW  |-- | PC4 |
   +-----+   +-----+   +-----+


スイッチング
============

PC1からPC3にフレームを送信する場合を考える。

1. PC1はSWに(ユニキャスト)フレームを転送する。
2. SWは送信元PC1のMACアドレスを学習する。
3. SWは受信したポート以外のポートへフレームを転送する(フラッディング)
4. PC3がフレームを受信する。

* SWはPC1のMACアドレスを学習したのでこれ以降、PC1宛のフレームをフラッディングしない。


::

   +-----+   +-----+   +-----+
   | PC1 |---| SW  |---| PC2 |
   +-----+   +-----+   +-----+
            /   |   \
   +-----+ / +-----+ \ +-----+
   | PC3 |/  | PC4 |  \| PC5 |
   +-----+   +-----+   +-----+

ブロードキャスト
=================

* MACアドレス FF-FF-FF-FF-FF-FF に送信する。
* L2ネットワーク内のすべてのノードにフレームを送信する。
* 結構頻繁に発生する。

  * ARPリクエスト
  * DHCP

* ネットワーク設計上、ブロードキャストドメインはなるべく小さい方が良い。

  * ブロードキャストドメインを小さくするための対策としてのVLAN

VLAN
=====

* 物理的には1台のスイッチ内に仮想のスイッチが複数台存在するイメージ。
* 物理ポートに縛られず、柔軟にL2ネットワークを構築できる。
* VLAN間で通信するにはL3(VLAN間)ルーティングが必要。

::

                  +----------+
                  |    RT    |
                  +----------+
                       |
   +----------+   +----------+   +----------+
   | PC1(VL1) |---|   L2SW   |---| PC2(VL2) |
   +----------+   +----------+   +----------+
                 /     |      \
   +----------+ / +----------+ \ +----------+
   | PC3(VL1) |/  | PC4(VL1) |  \| PC5(VL2) |
   +----------+   +----------+   +----------+

VLAN(用語)
==========

* スイッチポート

  * アクセスポート

    * 1つのVLANのみ所属できるポート
    * いわゆる普通のスイッチポート

  * トランクポート

    * 複数のVLANに所属できるポート
    * フレームについているVLANで所属VLANを判別する。

      * linuxだとaptitude install vlanでvlanタグを付けたフレームを転送できる機能がインストールできるよ!!

  * ルーテッドポート

    * IPアドレス割り振られているポート
    * ルーターのインターフェースのイメージ

  * SVI

    * L3スイッチの内部インターフェース

* VLANの形式

  * スタティックVLAN
  * ダイナミックVLAN

VLAN間ルーティング
===================

ルータがトランクポートに非対応の場合、ルータのポートを2つ使う。

::

                  +----------+
                  |    RT    |
                  +----------+
             VL1 →  |    | ← VL2
   +----------+   +----------+   +----------+
   | PC1(VL1) |---|   L2SW   |---| PC2(VL2) |
   +----------+   +----------+   +----------+
                 /     |      \
   +----------+ / +----------+ \ +----------+
   | PC3(VL1) |/  | PC4(VL1) |  \| PC5(VL2) |
   +----------+   +----------+   +----------+

VLAN間ルーティング cont...
===========================

ルータがトランクポートに対応の場合、ルータのポートを1つにサブインターフェースを割り当てる。

::

                  +----------+
                  |    RT    |
                  +----------+
                        | ← トランクポート
   +----------+   +----------+   +----------+
   | PC1(VL1) |---|   L2SW   |---| PC2(VL2) |
   +----------+   +----------+   +----------+
                 /      |     \
   +----------+ / +----------+ \ +----------+
   | PC3(VL1) |/  | PC4(VL1) |  \| PC5(VL2) |
   +----------+   +----------+   +----------+

VLAN間ルーティング cont....
============================

L3スイッチを使う場合、L3スイッチ内でルーティングをすることができる。

::

   +----------+   +----------+   +----------+
   | PC1(VL1) |---|   L3SW   |---| PC2(VL2) |
   +----------+   +----------+   +----------+
                 /     |      \
   +----------+ / +----------+ \ +----------+
   | PC3(VL1) |/  | PC4(VL1) |  \| PC5(VL2) |
   +----------+   +----------+   +----------+

ブロードキャストストーム
========================

PC1からにブロードキャストフレームを送信する場合を考える。

1. PC1からSW1に送信される。
2. SW1からSW2とSW3にフラッディングされる。
3. SW2からSW4とPC2にフラッディングされる。
4. SW4からSW3とPC4にフラッディングされる。
5. SW3からSW1とPC3にフラッディングされる。
6. ...以下繰り返し。

::

   +-----+   +-----+   +-----+   +-----+
   | PC1 |---| SW1 |---| SW2 |---| PC2 |
   +-----+   +-----+   +-----+   +-----+
                |         |
   +-----+   +-----+   +-----+   +-----+
   | PC3 |---| SW3 |---| SW4 |---| PC4 |
   +-----+   +-----+   +-----+   +-----+

STP
====

* Spanning Tree Protocol
* ブロードキャストストームを防ぐための技術
* ループにならないようあらかじめ計算されたポートをブロック状態にしておく。

  * L2ネットワークが論理上ツリー構造になる。

* 障碍時に自動的に有効となる。(冗長性)
* VLANごとにツリー構成を変えることができる。(負荷分散)


STP(用語)
=========

* BPDU

  * STPの情報をやりとりするパケット

* ルートブリッジ

  * ブリッジIDが1番小さいスイッチ

* ルートポート RP

  * ルートブリッジ以外のスイッチの内一番、ルートブリッジに近いポート。ルートブリッジからのBPDUを受信するポート

* 指定ポート DP

  * 一番ルートブリッジに近いポート。ルートブリッジからのBPDUを送信する。

* ブロックポート(非指定ポート) NDP

  * ルートポート、指定ポートに選ばれなかったポート。データの送受信ができない。

* ブリッジID

  * プライオリティ + MACアドレスの値

* 近い遠いの計算はコスト値で決まる。

STPのコストの優先順位
=====================

1. ルートブリッジへのコストの累計で比較
2. 送信元ブリッジIDで比較
3. 送信元ポートIDで比較

STP 構成
=========

* SW1: ブリッジID 1
* SW2: ブリッジID 2
* SW3: ブリッジID 3
* SW4: ブリッジID 4

::

   +---------+ DP   RP +---------+
   |   SW1   |---------|   SW2   |
   +---------+         +---------+
        | DP                | DP
        |                   |
        | RP                | RP
   +---------+ DP  NDP +---------+
   |   SW3   |---------|   SW4   |
   +---------+         +---------+

STP その他細かいトピック
=========================

* STPを高速化したRSTP
* STPをグループ化したMST
* VLANごとのSTPであるPVST
* STP以外のL2の冗長化技術であるリンクアグリケーション
